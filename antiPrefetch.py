# This is a script that disables prefetching form windows systems, and with
# It makes it very hard for Forensic Investigators after a system
# compromise.

# __author__ == '0ptimusPr1m3'

from _winreg import *
import os, sys

def getValue(net):
    try:
        # open the key and return the value object
        hkey = OpenKey(HKEY_LOCAL_MACHINE, net)

        # read hte value
        result = QueryValueEx(hkey, "EnablePrefetcher")

        # close the handle to the object
        CloseKey(hkey)
        return result[0]
    except WindowsError:
        pass

def modifyValue(net, val):

    # rkey = ConnectRegistry(None, HKEY_LOCAL_MACHINE)

    hkey = OpenKey(HKEY_LOCAL_MACHINE, net, 0, KEY_ALL_ACCESS)
    try:
        SetValueEx(hkey, "EnablePrefetcher", 0, REG_DWORD, val)
    except EnvironmentError:
        print "Had errors, writing in the windows registry"
    CloseKey(hkey)
   # CloseKey(rkey)


def main():

    if os.name != "nt":
        print "Please run this script on a Windows Machine"
        sys.exit(0)

    net = "SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\PrefetchParameters"

    val = ''
    print "Welcome to the Anti Prefetching script"

    ans = raw_input("Enable (E) or Disable (D) prefetching: ")

    if ans == "E":
        val = int("3")
        print "[+] Modifying (Enabling) the Registry Key"
        modifyValue(net, val)
        print "The value has been modified to %d (Enabled)." % getValue(net)
    elif ans == "D":
        val = int("0")
        print "[+] Modifying (Disabling) the registry Key"
        modifyValue(net, val)
        print "The value has been modified to %d (Disabled)." % getValue(net)

if __name__ == "__main__":
    main()
